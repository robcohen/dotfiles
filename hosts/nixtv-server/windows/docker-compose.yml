# hosts/nixtv-server/windows/docker-compose.yml
# Media server + AI services running on Windows with Podman
#
# Prerequisites:
#   - Podman Desktop with WSL2 backend
#   - NVIDIA GPU with drivers installed
#   - NVIDIA Container Toolkit for Podman
#   - Copy .env.example to .env and configure
#
# Usage:
#   podman-compose up -d
#   podman-compose logs -f
#   podman-compose down
#
# Web UIs (via Tailscale only):
#   - Homarr:      http://nixtv-win:7575  (Dashboard - start here!)
#   - Jellyfin:    http://nixtv-win:8096
#   - Jellyseerr:  http://nixtv-win:5055
#   - Ollama:      http://nixtv-win:11434
#   - Open WebUI:  http://nixtv-win:3000
#   - Radarr:      http://nixtv-win:7878
#   - Sonarr:      http://nixtv-win:8989
#   - Prowlarr:    http://nixtv-win:9696
#   - Lidarr:      http://nixtv-win:8686
#   - Readarr:     http://nixtv-win:8787
#   - Bazarr:      http://nixtv-win:6767
#   - qBittorrent: http://nixtv-win:8080
#   - Tdarr:       http://nixtv-win:8265
#   - Uptime Kuma: http://nixtv-win:3001

services:
  # ===========================================================================
  # Jellyfin - Media streaming with GPU transcoding
  # ===========================================================================
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    # GPU passthrough for NVIDIA (uncomment after configuring CDI)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu, video]
    ports:
      - "8096:8096"     # Web UI
      - "8920:8920"     # HTTPS (optional)
      - "1900:1900/udp" # DLNA discovery
      - "7359:7359/udp" # Client discovery
    volumes:
      - /mnt/c/ProgramData/nixtv/Jellyfin/config:/config
      - /mnt/c/ProgramData/nixtv/Jellyfin/cache:/cache
      - /mnt/c/Media:/media:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all

  # ===========================================================================
  # Ollama - Local LLM inference with GPU
  # ===========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    # GPU passthrough (uncomment after configuring CDI)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu, compute]
    ports:
      - "11434:11434"
    volumes:
      - /mnt/c/ProgramData/nixtv/Ollama:/root/.ollama
    environment:
      - NVIDIA_VISIBLE_DEVICES=all

  # ===========================================================================
  # Open WebUI - Chat interface for Ollama
  # ===========================================================================
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3000:8080"
    volumes:
      - /mnt/c/ProgramData/nixtv/OpenWebUI:/app/backend/data
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
    depends_on:
      - ollama

  # ===========================================================================
  # Prowlarr - Indexer manager (configure this first!)
  # ===========================================================================
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    ports:
      - "9696:9696"
    volumes:
      - /mnt/c/ProgramData/nixtv/Prowlarr:/config
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}

  # ===========================================================================
  # Radarr - Movie management
  # ===========================================================================
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    ports:
      - "7878:7878"
    volumes:
      - /mnt/c/ProgramData/nixtv/Radarr:/config
      - /mnt/c/Media/Movies:/movies
      - /mnt/c/Media/Downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    depends_on:
      - prowlarr

  # ===========================================================================
  # Sonarr - TV show management
  # ===========================================================================
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    ports:
      - "8989:8989"
    volumes:
      - /mnt/c/ProgramData/nixtv/Sonarr:/config
      - /mnt/c/Media/TV:/tv
      - /mnt/c/Media/Downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    depends_on:
      - prowlarr

  # ===========================================================================
  # Lidarr - Music management
  # ===========================================================================
  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    restart: unless-stopped
    ports:
      - "8686:8686"
    volumes:
      - /mnt/c/ProgramData/nixtv/Lidarr:/config
      - /mnt/c/Media/Music:/music
      - /mnt/c/Media/Downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    depends_on:
      - prowlarr

  # ===========================================================================
  # Readarr - Book/audiobook management
  # ===========================================================================
  readarr:
    image: ghcr.io/hotio/readarr:latest
    container_name: readarr
    restart: unless-stopped
    ports:
      - "8787:8787"
    volumes:
      - /mnt/c/ProgramData/nixtv/Readarr:/config
      - /mnt/c/Media/Books:/books
      - /mnt/c/Media/Downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    depends_on:
      - prowlarr

  # ===========================================================================
  # Bazarr - Subtitle management
  # ===========================================================================
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    restart: unless-stopped
    ports:
      - "6767:6767"
    volumes:
      - /mnt/c/ProgramData/nixtv/Bazarr:/config
      - /mnt/c/Media/Movies:/movies
      - /mnt/c/Media/TV:/tv
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    depends_on:
      - radarr
      - sonarr

  # ===========================================================================
  # qBittorrent - Download client
  # ===========================================================================
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    ports:
      - "8080:8080"   # Web UI
      - "6881:6881"   # Torrent port
      - "6881:6881/udp"
    volumes:
      - /mnt/c/ProgramData/nixtv/qBittorrent:/config
      - /mnt/c/Media/Downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - WEBUI_PORT=8080

  # ===========================================================================
  # Homarr - Dashboard for all services
  # ===========================================================================
  homarr:
    image: ghcr.io/ajnart/homarr:latest
    container_name: homarr
    restart: unless-stopped
    ports:
      - "7575:7575"
    volumes:
      - /mnt/c/ProgramData/nixtv/Homarr/configs:/app/data/configs
      - /mnt/c/ProgramData/nixtv/Homarr/icons:/app/public/icons
      - /mnt/c/ProgramData/nixtv/Homarr/data:/data
    environment:
      - TZ=${TZ:-America/New_York}

  # ===========================================================================
  # Jellyseerr - Media request management
  # ===========================================================================
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    restart: unless-stopped
    ports:
      - "5055:5055"
    volumes:
      - /mnt/c/ProgramData/nixtv/Jellyseerr:/app/config
    environment:
      - TZ=${TZ:-America/New_York}
    depends_on:
      - jellyfin
      - radarr
      - sonarr

  # ===========================================================================
  # Flaresolverr - Cloudflare bypass for indexers
  # ===========================================================================
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    ports:
      - "8191:8191"
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ:-America/New_York}

  # ===========================================================================
  # Recyclarr - TRaSH Guides sync for Radarr/Sonarr
  # ===========================================================================
  recyclarr:
    image: ghcr.io/recyclarr/recyclarr:latest
    container_name: recyclarr
    restart: unless-stopped
    volumes:
      - /mnt/c/ProgramData/nixtv/Recyclarr:/config
    environment:
      - TZ=${TZ:-America/New_York}
      - RECYCLARR_CREATE_CONFIG=true

  # ===========================================================================
  # Tdarr - Media transcoding with GPU
  # ===========================================================================
  tdarr:
    image: ghcr.io/haveagitgat/tdarr:latest
    container_name: tdarr
    restart: unless-stopped
    # GPU passthrough (uncomment after configuring CDI)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu, video]
    ports:
      - "8265:8265"   # Web UI
      - "8266:8266"   # Server port
    volumes:
      - /mnt/c/ProgramData/nixtv/Tdarr/server:/app/server
      - /mnt/c/ProgramData/nixtv/Tdarr/configs:/app/configs
      - /mnt/c/ProgramData/nixtv/Tdarr/logs:/app/logs
      - /mnt/c/Media:/media
      - /mnt/c/ProgramData/nixtv/Tdarr/transcode_cache:/temp
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
      - internalNode=true
      - inContainer=true
      - nodeName=WindowsNode
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all

  # ===========================================================================
  # Uptime Kuma - Service monitoring
  # ===========================================================================
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime-kuma
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      - /mnt/c/ProgramData/nixtv/UptimeKuma:/app/data

  # ===========================================================================
  # Watchtower - Auto-update containers
  # ===========================================================================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /run/user/1000/podman/podman.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ:-America/New_York}
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 0 4 * * *
      - WATCHTOWER_NOTIFICATIONS=${WATCHTOWER_NOTIFICATION_URL:+shoutrrr}
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}

# Caddyfile for wintv
# Reverse proxy for all services with Tailscale HTTPS + oauth2-proxy forward auth
#
# Uses host.containers.internal to reach services via their exposed ports
# Deploy to: C:\ProgramData\wintv\Caddy\Caddyfile
#
# Authentication:
#   - All routes protected by oauth2-proxy forward auth
#   - Login: https://{DOMAIN}/oauth2/sign_in
#   - Kanidm admin: https://{DOMAIN}:8443 (direct, not proxied)
#
# NOTE: Replace {DOMAIN} with your Tailscale domain before deploying
# Example: wintv.lorikeet-crested.ts.net

{DOMAIN} {
    tls /certs/{DOMAIN}.crt /certs/{DOMAIN}.key

    # =========================================================================
    # oauth2-proxy endpoints (must not be protected)
    # =========================================================================
    handle /oauth2/* {
        reverse_proxy oauth2-proxy:4180
    }

    # =========================================================================
    # Protected routes - forward auth via oauth2-proxy
    # =========================================================================

    # Media - configured with UrlBase
    handle /jellyfin/* {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            copy_headers X-Auth-Request-User X-Auth-Request-Email
        }
        reverse_proxy host.containers.internal:8096
    }

    # *arr stack - configured with UrlBase
    handle /radarr/* {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            copy_headers X-Auth-Request-User X-Auth-Request-Email
        }
        reverse_proxy host.containers.internal:7878
    }

    handle /sonarr/* {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            copy_headers X-Auth-Request-User X-Auth-Request-Email
        }
        reverse_proxy host.containers.internal:8989
    }

    handle /prowlarr/* {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            copy_headers X-Auth-Request-User X-Auth-Request-Email
        }
        reverse_proxy host.containers.internal:9696
    }

    handle /lidarr/* {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            copy_headers X-Auth-Request-User X-Auth-Request-Email
        }
        reverse_proxy host.containers.internal:8686
    }

    handle /readarr/* {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            copy_headers X-Auth-Request-User X-Auth-Request-Email
        }
        reverse_proxy host.containers.internal:8787
    }

    handle /bazarr/* {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            copy_headers X-Auth-Request-User X-Auth-Request-Email
        }
        reverse_proxy host.containers.internal:6767
    }

    # qBittorrent - strip prefix
    handle_path /qbittorrent/* {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            copy_headers X-Auth-Request-User X-Auth-Request-Email
        }
        reverse_proxy host.containers.internal:8080
    }

    # AI - strip prefix
    handle_path /ollama/* {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            copy_headers X-Auth-Request-User X-Auth-Request-Email
        }
        reverse_proxy host.containers.internal:11434
    }

    handle_path /chat/* {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            copy_headers X-Auth-Request-User X-Auth-Request-Email
        }
        reverse_proxy host.containers.internal:3000
    }

    # Tdarr - strip prefix
    handle_path /tdarr/* {
        forward_auth oauth2-proxy:4180 {
            uri /oauth2/auth
            copy_headers X-Auth-Request-User X-Auth-Request-Email
        }
        reverse_proxy host.containers.internal:8265
    }

    # Root - redirect to Kanidm apps page
    handle {
        redir / https://{DOMAIN}:8443/ui/apps permanent
    }
}

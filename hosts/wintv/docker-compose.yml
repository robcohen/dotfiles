# hosts/wintv/docker-compose.yml
# Media server + AI services running on Windows with Podman
#
# Prerequisites:
#   - Podman Desktop with WSL2 backend
#   - NVIDIA GPU with drivers installed
#   - NVIDIA Container Toolkit for Podman
#   - Copy .env.example to .env and configure
#
# Usage:
#   podman-compose up -d
#   podman-compose logs -f
#   podman-compose down
#
# Access (via Tailscale HTTPS):
#   https://wintv.lorikeet-crested.ts.net/
#
# Routes:
#   /jellyfin    - Jellyfin
#   /radarr      - Radarr
#   /sonarr      - Sonarr
#   /prowlarr    - Prowlarr
#   /lidarr      - Lidarr
#   /readarr     - Readarr
#   /bazarr      - Bazarr
#   /qbittorrent - qBittorrent
#   /chat        - Open WebUI
#   /ollama      - Ollama API
#   /tdarr       - Tdarr
#
# Authentication:
#   All routes protected by oauth2-proxy forward auth
#   Login at: https://{DOMAIN}/oauth2/sign_in
#   Kanidm admin: https://{DOMAIN}:8443

services:
  # ===========================================================================
  # Caddy - Reverse proxy with Tailscale HTTPS
  # ===========================================================================
  caddy:
    image: caddy:latest
    container_name: caddy
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - /mnt/c/ProgramData/wintv/Caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - /mnt/c/ProgramData/wintv/certs:/certs:ro
      - /mnt/c/ProgramData/wintv/Caddy/data:/data
      - /mnt/c/ProgramData/wintv/Caddy/config:/config
    environment:
      - TZ=${TZ:-America/New_York}
    depends_on:
      - oauth2-proxy

  # ===========================================================================
  # Kanidm - Identity provider (Rust-based, OIDC/OAuth2)
  # ===========================================================================
  kanidm:
    image: kanidm/server:latest
    container_name: kanidm
    restart: unless-stopped
    ports:
      - "8443:8443"
    volumes:
      - /mnt/c/ProgramData/wintv/Kanidm:/data
      - /mnt/c/ProgramData/wintv/certs:/data/certs:ro
    tmpfs:
      - /run/kanidm:rw,size=10m
    environment:
      - TZ=${TZ:-America/New_York}

  # ===========================================================================
  # oauth2-proxy - Forward auth for apps without OIDC support
  # ===========================================================================
  # NOTE: No external port exposure - Caddy accesses via docker network (oauth2-proxy:4180)
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    container_name: oauth2-proxy
    restart: unless-stopped
    # Port 4180 only accessible within docker network (by Caddy)
    expose:
      - "4180"
    environment:
      - OAUTH2_PROXY_PROVIDER=oidc
      - OAUTH2_PROXY_PROVIDER_DISPLAY_NAME=Kanidm
      - OAUTH2_PROXY_CLIENT_ID=oauth2-proxy
      - OAUTH2_PROXY_CLIENT_SECRET=${OAUTH2_PROXY_CLIENT_SECRET}
      - OAUTH2_PROXY_REDIRECT_URL=https://${DOMAIN}/oauth2/callback
      - OAUTH2_PROXY_OIDC_ISSUER_URL=https://kanidm:8443/oauth2/openid/oauth2-proxy
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_PROXY_COOKIE_SECRET}
      - OAUTH2_PROXY_COOKIE_SECURE=true
      - OAUTH2_PROXY_COOKIE_DOMAINS=.${DOMAIN}
      - OAUTH2_PROXY_UPSTREAMS=static://200
      # Bind only to container network interface (not exposed externally)
      - OAUTH2_PROXY_HTTP_ADDRESS=:4180
      - OAUTH2_PROXY_REVERSE_PROXY=true
      - OAUTH2_PROXY_SET_XAUTHREQUEST=true
      - OAUTH2_PROXY_PASS_ACCESS_TOKEN=true
      - OAUTH2_PROXY_CODE_CHALLENGE_METHOD=S256
      - OAUTH2_PROXY_SKIP_PROVIDER_BUTTON=true
      # SSL verification skip is acceptable here: container-to-container traffic
      # within the same trusted docker network. The cert hostname mismatch (kanidm
      # container name vs external domain) requires this for internal OIDC communication.
      - OAUTH2_PROXY_SSL_INSECURE_SKIP_VERIFY=true
    depends_on:
      - kanidm

  # ===========================================================================
  # Jellyfin - Media streaming with GPU transcoding
  # ===========================================================================
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    devices:
      - nvidia.com/gpu=all
    ports:
      - "8096:8096"     # Web UI
      - "8920:8920"     # HTTPS (optional)
      - "1900:1900/udp" # DLNA discovery
      - "7359:7359/udp" # Client discovery
    volumes:
      - /mnt/c/ProgramData/wintv/Jellyfin/config:/config
      - /mnt/c/ProgramData/wintv/Jellyfin/cache:/cache
      - /mnt/c/Media:/media:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all

  # ===========================================================================
  # Ollama - Local LLM inference with GPU
  # ===========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    devices:
      - nvidia.com/gpu=all
    ports:
      - "11434:11434"
    volumes:
      - /mnt/c/ProgramData/wintv/Ollama:/root/.ollama
    environment:
      - NVIDIA_VISIBLE_DEVICES=all

  # ===========================================================================
  # Open WebUI - Chat interface for Ollama
  # ===========================================================================
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3000:8080"
    volumes:
      - /mnt/c/ProgramData/wintv/OpenWebUI:/app/backend/data
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
    depends_on:
      - ollama

  # ===========================================================================
  # Prowlarr - Indexer manager (configure this first!)
  # ===========================================================================
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    restart: unless-stopped
    ports:
      - "9696:9696"
    volumes:
      - /mnt/c/ProgramData/wintv/Prowlarr:/config
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}

  # ===========================================================================
  # Radarr - Movie management
  # ===========================================================================
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    ports:
      - "7878:7878"
    volumes:
      - /mnt/c/ProgramData/wintv/Radarr:/config
      - /mnt/c/Media/Movies:/movies
      - /mnt/c/Media/Downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    depends_on:
      - prowlarr

  # ===========================================================================
  # Sonarr - TV show management
  # ===========================================================================
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    restart: unless-stopped
    ports:
      - "8989:8989"
    volumes:
      - /mnt/c/ProgramData/wintv/Sonarr:/config
      - /mnt/c/Media/TV:/tv
      - /mnt/c/Media/Downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    depends_on:
      - prowlarr

  # ===========================================================================
  # Lidarr - Music management
  # ===========================================================================
  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    restart: unless-stopped
    ports:
      - "8686:8686"
    volumes:
      - /mnt/c/ProgramData/wintv/Lidarr:/config
      - /mnt/c/Media/Music:/music
      - /mnt/c/Media/Downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    depends_on:
      - prowlarr

  # ===========================================================================
  # Readarr - Book/audiobook management
  # ===========================================================================
  readarr:
    image: ghcr.io/hotio/readarr:latest
    container_name: readarr
    restart: unless-stopped
    ports:
      - "8787:8787"
    volumes:
      - /mnt/c/ProgramData/wintv/Readarr:/config
      - /mnt/c/Media/Books:/books
      - /mnt/c/Media/Downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    depends_on:
      - prowlarr

  # ===========================================================================
  # Bazarr - Subtitle management
  # ===========================================================================
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    restart: unless-stopped
    ports:
      - "6767:6767"
    volumes:
      - /mnt/c/ProgramData/wintv/Bazarr:/config
      - /mnt/c/Media/Movies:/movies
      - /mnt/c/Media/TV:/tv
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    depends_on:
      - radarr
      - sonarr

  # ===========================================================================
  # qBittorrent - Download client
  # ===========================================================================
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    ports:
      - "8080:8080"   # Web UI
      - "6881:6881"   # Torrent port
      - "6881:6881/udp"
    volumes:
      - /mnt/c/ProgramData/wintv/qBittorrent:/config
      - /mnt/c/Media/Downloads:/downloads
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - WEBUI_PORT=8080

  # ===========================================================================
  # Seerr - Media request management (Jellyseerr/Overseerr unified)
  # ===========================================================================
  seerr:
    image: ghcr.io/hotio/seerr:latest
    container_name: seerr
    restart: unless-stopped
    ports:
      - "5055:5055"
    volumes:
      - /mnt/c/ProgramData/wintv/Seerr:/app/config
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
    depends_on:
      - jellyfin
      - radarr
      - sonarr

  # ===========================================================================
  # Flaresolverr - Cloudflare bypass for indexers
  # ===========================================================================
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    ports:
      - "8191:8191"
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ:-America/New_York}

  # ===========================================================================
  # Recyclarr - TRaSH Guides sync for Radarr/Sonarr
  # ===========================================================================
  recyclarr:
    image: ghcr.io/recyclarr/recyclarr:latest
    container_name: recyclarr
    restart: unless-stopped
    volumes:
      - /mnt/c/ProgramData/wintv/Recyclarr:/config
    environment:
      - TZ=${TZ:-America/New_York}
      - RECYCLARR_CREATE_CONFIG=true

  # ===========================================================================
  # Tdarr - Media transcoding with GPU
  # ===========================================================================
  tdarr:
    image: ghcr.io/haveagitgat/tdarr:latest
    container_name: tdarr
    restart: unless-stopped
    devices:
      - nvidia.com/gpu=all
    ports:
      - "8265:8265"   # Web UI
      - "8266:8266"   # Server port
    volumes:
      - /mnt/c/ProgramData/wintv/Tdarr/server:/app/server
      - /mnt/c/ProgramData/wintv/Tdarr/configs:/app/configs
      - /mnt/c/ProgramData/wintv/Tdarr/logs:/app/logs
      - /mnt/c/Media:/media
      - /mnt/c/ProgramData/wintv/Tdarr/transcode_cache:/temp
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
      - internalNode=true
      - inContainer=true
      - nodeName=WindowsNode
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all

  # ===========================================================================
  # Uptime Kuma - Service monitoring
  # ===========================================================================
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime-kuma
    restart: unless-stopped
    ports:
      - "3001:3001"
    volumes:
      - /mnt/c/ProgramData/wintv/UptimeKuma:/app/data

  # ===========================================================================
  # Watchtower - Auto-update containers
  # ===========================================================================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /run/user/1000/podman/podman.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ:-America/New_York}
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 0 4 * * *
      - WATCHTOWER_NOTIFICATIONS=${WATCHTOWER_NOTIFICATION_URL:+shoutrrr}
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
